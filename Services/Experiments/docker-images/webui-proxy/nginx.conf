worker_processes 1;
 
events { worker_connections 1024; }
 
http {
    sendfile on;

    map $http_referer $referer_proxy_host {
        default       '';
        "~^http://[a-zA-Z0-9-_\.]+(?::\d+)?/([a-zA-Z0-9-_\.]+:\d+)/" $1;
    }

    server {
        listen 8080;

        root /usr/share/nginx/websrc;
 
        location = / {
            return 301 /landing.html;
        }

        # note: this is ssrf + xss, but oh well
        location ~ ^/([a-zA-Z0-9-_\.]+:\d+)(/[a-zA-Z0-9-_\./:]*)?$ {
            resolver 127.0.0.11; # allows resolving endpoints by hostname
            proxy_pass http://$1$2$is_args$args;
            proxy_redirect ~^http://([a-zA-Z0-9-_\.]+:\d+)/(.*)$ /$1/$2;
            proxy_set_header Accept-Encoding "";
            sub_filter_once on;
            sub_filter '<html>' '<html><script src="/static/href-origin-fixup.js"></script>';
        }

        location / {
            try_files $uri $uri/ @default;
            charset utf-8;
            source_charset utf-8;
        }

        location @default {
            return 302 /$referer_proxy_host$request_uri;
        }
    }
}
